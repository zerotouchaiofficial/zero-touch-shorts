name: ðŸŽ¬ Daily YouTube Shorts Generator

on:
  schedule:
    # 10 videos per day â€” every 2.5 hours starting midnight UTC
    - cron: '0 0  * * *'
    - cron: '0 2  * * *'
    - cron: '0 4  * * *'
    - cron: '0 6  * * *'
    - cron: '0 8  * * *'
    - cron: '0 10 * * *'
    - cron: '0 12 * * *'
    - cron: '0 14 * * *'
    - cron: '0 16 * * *'
    - cron: '0 18 * * *'
  workflow_dispatch:   # â† lets you trigger manually from GitHub UI too

jobs:
  generate-and-upload:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:

    # â”€â”€ 1. Checkout repo â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4

    # â”€â”€ 2. Python setup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ðŸ Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    # â”€â”€ 3. System dependencies â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ðŸ“¦ Install system packages
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y -qq \
          imagemagick ffmpeg \
          fonts-dejavu-core fonts-liberation \
          python3-dev
        # Fix ImageMagick policy
        sudo mv /etc/ImageMagick-6/policy.xml \
                /etc/ImageMagick-6/policy.xml.bak || true

    # â”€â”€ 4. Python dependencies â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ðŸ Install Python packages
      run: pip install -r requirements.txt

    # â”€â”€ 5. Generate video number (based on time) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ðŸ”¢ Set video number
      id: vidnum
      run: |
        # Unique number from date + hour so parallel runs don't clash
        VID_NUM=$(date +'%Y%m%d%H')
        echo "video_number=$VID_NUM" >> $GITHUB_OUTPUT
        echo "Video number: $VID_NUM"

    # â”€â”€ 6. Generate Short + Thumbnail â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ðŸŽ¬ Generate YouTube Short
      env:
        UNSPLASH_KEY: ${{ secrets.UNSPLASH_KEY }}
      run: |
        python -c "
        import sys
        sys.path.insert(0, '.')
        from scripts.generate_short import generate
        vid, thumb, facts = generate(${{ steps.vidnum.outputs.video_number }})
        print(f'VIDEO={vid}')
        print(f'THUMB={thumb}')
        with open('output_paths.txt','w') as f:
            f.write(vid + '\n')
            f.write(thumb + '\n')
        "

    # â”€â”€ 7. Upload to YouTube â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ðŸ“¤ Upload to YouTube
      env:
        YT_CLIENT_ID:     ${{ secrets.YT_CLIENT_ID }}
        YT_CLIENT_SECRET: ${{ secrets.YT_CLIENT_SECRET }}
        YT_REFRESH_TOKEN: ${{ secrets.YT_REFRESH_TOKEN }}
      run: |
        python -c "
        import sys, os
        sys.path.insert(0, '.')

        with open('output_paths.txt') as f:
            lines = f.read().strip().split('\n')
        vid_path   = lines[0]
        thumb_path = lines[1]

        from scripts.generate_short import generate
        # Re-load facts from the already-generated audio folder
        import glob, json
        # Load facts from already-generated run
        facts_file = vid_path.replace('/short.mp4','/facts.json')
        if os.path.exists(facts_file):
            import json
            facts = json.load(open(facts_file))
        else:
            facts = ['Amazing facts about the world']

        from scripts.upload_youtube import upload_video
        vid_id, url = upload_video(
            vid_path, facts,
            int('${{ steps.vidnum.outputs.video_number }}')
        )
        print(f'âœ… Uploaded: {url}')
        print(f'video_id={vid_id}')
        print(f'url={url}')
        " 2>&1

    # â”€â”€ 8. Cleanup to save disk space â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ðŸ§¹ Cleanup generated files
      if: always()
      run: |
        rm -rf output/ _audio/ _images/ || true
        echo "âœ… Cleaned up"

    # â”€â”€ 9. Upload logs as artifact (for debugging) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ðŸ“‹ Save run log
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: run-log-${{ steps.vidnum.outputs.video_number }}
        path: output_paths.txt
        retention-days: 7
